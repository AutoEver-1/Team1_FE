<!-- src/pages/FolloweesReviewsPage.vue -->
<script setup>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1) ë¼ì´ë¸ŒëŸ¬ë¦¬ & ì»´í¬ë„ŒíŠ¸ import
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
import { ref, computed, onMounted, onBeforeUnmount } from "vue";
import BaseBackground from "../components/common/BaseBackground.vue";

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  2) ë”ë¯¸ ë°ì´í„° (ìµœì‹ ìˆœ ì •ë ¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const allReviews = [
  {
    id: 1,
    date: "2025-07-15",
    user: {
      nickname: "ì•„íŠ¸í•˜ìš°ìŠ¤L",
      role: "ë°°ìš°",
      preference: "ë©œë¡œ Â· ë¡œë“œë¬´ë¹„",
      avatar: "https://i.pravatar.cc/150?img=11",
    },
    movie: {
      title: "ë¼ë¼ëœë“œ",
      genre: "ë®¤ì§€ì»¬ Â· ë¡œë§¨ìŠ¤",
      avgScore: 4.6,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/uDO8zWDhfWwoFdKS4fzkUJt0Rf0.jpg",
    },
    myScore: 5,
    likeCount: 45,
    content: "ì¬ì¦ˆì™€ ì‚¬ë‘, ê·¸ ì•„ë¦„ë‹µê³ ë„ ì”ì“¸í•œ êµì°¨ì .",
  },
  {
    id: 1,
    date: "2025-07-15",
    user: {
      nickname: "ì•„íŠ¸í•˜ìš°ìŠ¤L",
      role: "ë°°ìš°",
      preference: "ë©œë¡œ Â· ë¡œë“œë¬´ë¹„",
      avatar: "https://i.pravatar.cc/150?img=11",
    },
    movie: {
      title: "ë¼ë¼ëœë“œ",
      genre: "ë®¤ì§€ì»¬ Â· ë¡œë§¨ìŠ¤",
      avgScore: 4.6,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/uDO8zWDhfWwoFdKS4fzkUJt0Rf0.jpg",
    },
    myScore: 5,
    likeCount: 45,
    content: "ì¬ì¦ˆì™€ ì‚¬ë‘, ê·¸ ì•„ë¦„ë‹µê³ ë„ ì”ì“¸í•œ êµì°¨ì .",
  },
  {
    id: 2,
    date: "2025-07-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  {
    id: 2,
    date: "2025-06-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  {
    id: 2,
    date: "2025-05-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  {
    id: 2,
    date: "2025-04-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  {
    id: 2,
    date: "2025-03-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  {
    id: 2,
    date: "2023-07-14",
    user: {
      nickname: "ë¬´ë¹„ë•í›„",
      role: "ê´€ê°",
      preference: "ìŠ¤ë¦´ëŸ¬ Â· SF",
      avatar: "https://i.pravatar.cc/150?img=1",
    },
    movie: {
      title: "ì¸í„°ìŠ¤í…”ë¼",
      genre: "SF",
      avgScore: 4.5,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/8nO6UVikWSXVjRMzYbQV4MbEJyB.jpg",
    },
    myScore: 5,
    likeCount: 12,
    content:
      "ë¸”ë™í™€Â·ìƒëŒ€ì„±ì´ë¡ Â·ë¶€ë…€æ„›ê¹Œì§€ ì™„ë²½í•œ ìš°ì£¼ ê°€ì¡±ì˜í™”. ì¿ í¼ì˜ â€œSTAYâ€ ì¥ë©´ì€ ëª‡ ë²ˆì„ ë´ë„ ëˆˆë¬¼ì„ ìì•„ë‚¸ë‹¤.",
  },
  /* í•„ìš”ì— ë”°ë¼ ë” ì¶”ê°€ â€¦ */
  {
    id: 15,
    date: "2025-07-01",
    user: {
      nickname: "FILM_J",
      role: "ê°ë…",
      preference: "ì•„íŠ¸ Â· ì‹¤í—˜",
      avatar: "https://i.pravatar.cc/150?img=8",
    },
    movie: {
      title: "í…Œë„·",
      genre: "ì•¡ì…˜ Â· SF",
      avgScore: 3.8,
      poster:
        "https://image.tsmb.org/t/p/w185_and_h278_bestv2/k68nPLbIST6NP96JmTxmZijEvCA.jpg",
    },
    myScore: 4,
    likeCount: 20,
    content:
      "ì—”íŠ¸ë¡œí”¼ ê±°ìŠ¤ë¦„ëˆê¹Œì§€ ì±™ê²¨ ê°€ëŠ” ë†€ë€ì˜ ì‹œê³„íƒœì—½. ë¨¸ë¦¬ë³´ë‹¤ ê·€ë¥¼ ë¯¿ì–´ì•¼ ì´í•´ê°€ ê°„ë‹¤.",
  },
].sort((a, b) => b.date.localeCompare(a.date)); // ìµœì‹ ìˆœ ì •ë ¬

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  3) ë¬´í•œìŠ¤í¬ë¡¤ ê´€ë ¨ ìƒíƒœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const PAGE_SIZE = 6;
const page = ref(0);
const visibleReviews = ref([]);
const endReached = ref(false);

/** ë‹¤ìŒ í˜ì´ì§€ë¥¼ visibleReviews ì— push */
function loadNextPage() {
  if (endReached.value) return;
  const start = page.value * PAGE_SIZE;
  const next = allReviews.slice(start, start + PAGE_SIZE);

  if (next.length) {
    visibleReviews.value.push(...next);
    page.value++;
  }
  if (visibleReviews.value.length >= allReviews.length) endReached.value = true;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  4) ë‚ ì§œë³„ ê·¸ë£¹í™” (YYYY-MM-DD)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const grouped = computed(() => {
  const map = new Map();
  visibleReviews.value.forEach((r) => {
    if (!map.has(r.date)) map.set(r.date, []);
    map.get(r.date).push(r);
  });
  return [...map.entries()].map(([date, reviews]) => ({ date, reviews }));
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  5) IntersectionObserver(ë¬´í•œìŠ¤í¬ë¡¤)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let observer = null;
const sentinel = ref(null);

function initObserver() {
  observer = new IntersectionObserver(
    (entries) => entries.forEach((e) => e.isIntersecting && loadNextPage()),
    { threshold: 1 }
  );
  if (sentinel.value) observer.observe(sentinel.value);
}

onMounted(() => {
  loadNextPage();
  initObserver();
});
onBeforeUnmount(() => {
  if (observer && sentinel.value) observer.unobserve(sentinel.value);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  6) (ë”ë¯¸) ì¢‹ì•„ìš” í† ê¸€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleLike(review) {
  review.likeCount++;
}
</script>

<template>
  <!-- ì–´ë‘ìš´ ë°°ê²½ ê°ì‹¸ê¸° -->
  <BaseBackground>
    <div class="mx-auto max-w-5xl px-4 py-20 sm:py-20 sm:px-6 lg:px-8 lg:py-32">
      <!-- ë‚ ì§œ ê·¸ë£¹ ë°˜ë³µ -->
      <div class="flex flex-col gap-8 sm:gap-10 lg:gap-14">
        <div
          v-for="group in grouped"
          :key="group.date"
          class="relative flex gap-4 sm:gap-6"
        >
          <!-- â”€â”€â”€â”€â”€ íƒ€ì„ë¼ì¸(ì—°Â·ì›”Â·ì¼) â”€â”€â”€â”€â”€ -->
          <div class="relative flex w-[10%] shrink-0 flex-col items-center">
            <div class="sticky top-20 z-20 flex flex-col items-end">
              <!-- ì—°ë„ -->
              <!-- <div class="sticky top-20 z-20 flex flex-col items-center"> -->
              <!-- <span
                class="z-30 h-4 w-4 rounded-full bg-amber-400 ring-4 ring-amber-300/40"
              />
              <span
                class="h-12 w-0.5 bg-gradient-to-b from-amber-400/80 to-transparent"
              /> -->
              <p class="sticky top-4 z-20 text-base font-bold">
                {{ group.date.slice(0, 4) }}
              </p>
              <!-- </div> -->
              <!-- ì›” -->
              <!-- <div class="sticky top-28 z-20 flex flex-col items-center"> -->
              <!-- <span
                class="z-30 h-4 w-4 rounded-full bg-amber-400 ring-4 ring-amber-300/40"
              />
              <span
                class="h-12 w-0.5 bg-gradient-to-b from-amber-400/80 to-transparent"
              /> -->
              <p class="sticky top-12 z-20 text-sm font-semibold">
                {{ group.date.slice(5, 7) }}
              </p>
              <!-- </div> -->
              <!-- ì¼ + ì  + ì„  -->
              <!-- <div class="sticky top-36 z-20 flex flex-col items-center"> -->
              <!-- <span
                class="z-30 h-4 w-4 rounded-full bg-amber-400 ring-4 ring-amber-300/40"
              />
              <span
                class="h-12 w-0.5 bg-gradient-to-b from-amber-400/80 to-transparent"
              /> -->
              <p class="text-sm font-semibold">
                {{ group.date.slice(8) }}
              </p>
              <!-- </div> -->
            </div>
          </div>

          <!-- â”€â”€â”€â”€â”€ ë¦¬ë·° ì¹´ë“œ ì˜ì—­ â”€â”€â”€â”€â”€ -->
          <div class="flex w-full flex-col gap-8 sm:gap-10 lg:gap-14">
            <div
              v-for="review in group.reviews"
              :key="review.id"
              class="relative w-full overflow-hidden rounded-2xl bg-white/50 p-4 shadow-lg backdrop-blur transition hover:scale-[1.02] sm:p-6"
            >
              <!-- ìƒë‹¨: ìœ ì € ì •ë³´ + ë³„ì  -->
              <div
                class="flex flex-col gap-4 border-b border-white/15 pb-4 sm:flex-row sm:items-center sm:justify-between"
              >
                <!-- ì•„ë°”íƒ€Â·ë‹‰ë„¤ì„Â·ì—­í•  -->
                <div class="flex items-center gap-3">
                  <img
                    :src="review.user.avatar"
                    alt="avatar"
                    class="h-10 w-10 rounded-full object-cover sm:h-12 sm:w-12"
                  />
                  <div>
                    <p
                      class="flex items-center gap-2 text-sm font-semibold text-white sm:text-base"
                    >
                      {{ review.user.nickname }}
                      <span
                        class="rounded bg-white/10 px-2 py-0.5 text-[10px] text-amber-200 sm:text-xs"
                      >
                        {{ review.user.role }}
                      </span>
                    </p>
                    <p class="text-[10px] text-white/60 sm:text-xs">
                      {{ review.user.preference }}
                    </p>
                  </div>
                </div>

                <!-- ë³„ì  -->
                <div class="flex items-center gap-0.5">
                  <svg
                    v-for="n in 5"
                    :key="n"
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    class="h-4 w-4 sm:h-5 sm:w-5"
                    :class="
                      n <= review.myScore ? 'text-yellow-400' : 'text-white/30'
                    "
                  >
                    <path
                      d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                    />
                  </svg>
                </div>
              </div>

              <!-- ì¤‘ë‹¨: ì˜í™” ì •ë³´ -->
              <div class="mt-4 flex gap-4">
                <img
                  :src="review.movie.poster"
                  alt="poster"
                  class="h-20 w-14 rounded object-cover shadow-sm sm:h-24 sm:w-16"
                />
                <div>
                  <p
                    class="truncate text-sm font-medium text-white sm:text-base"
                  >
                    {{ review.movie.title }}
                  </p>
                  <p class="text-[10px] text-white/60 sm:text-xs">
                    {{ review.movie.genre }}
                  </p>
                  <p
                    class="mt-1 flex items-center gap-1 text-xs text-white sm:text-sm"
                  >
                    í‰ê·  í‰ì 
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      class="h-3 w-3 sm:h-4 sm:w-4 text-yellow-400"
                    >
                      <path
                        d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                      />
                    </svg>
                    {{ review.movie.avgScore.toFixed(1) }}
                  </p>
                </div>
              </div>

              <!-- í•˜ë‹¨: ë¦¬ë·° ë‚´ìš© -->
              <p
                class="mt-4 line-clamp-4 text-xs leading-relaxed text-white/90 sm:mt-6 sm:text-sm border-b border-white/15 pb-4"
              >
                {{ review.content }}
              </p>

              <!-- ì¢‹ì•„ìš” -->
              <div class="flex justify-end">
                <button
                  class="mt-4 flex items-center gap-1 text-xs text-white/60 transition hover:text-amber-400 sm:text-sm"
                  @click="toggleLike(review)"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    class="h-4 w-4 sm:h-5 sm:w-5"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12 21C12 21 3 15 3 8.25C3 5.765 5.015 3.75 7.5 3.75C9.344 3.75 10.9 4.84 11.641 6.38C12.383 4.84 13.939 3.75 15.783 3.75C18.268 3.75 20.283 5.765 20.283 8.25C20.283 15 12.283 21 12.283 21L12 21Z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  {{ review.likeCount }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- sentinel (ë¬´í•œìŠ¤í¬ë¡¤ ëŒ€ìƒ) -->
      <div ref="sentinel" class="h-1"></div>

      <!-- ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ ë©”ì‹œì§€ -->
      <p
        v-if="endReached"
        class="mt-10 text-center text-xs text-white/60 sm:text-sm"
      >
        ëª¨ë“  ë¦¬ë·°ë¥¼ ë‹¤ í™•ì¸í–ˆì–´ìš”! ğŸ‰
      </p>
    </div>
  </BaseBackground>
</template>

<style scoped>
/* Tailwind line-clamp í”ŒëŸ¬ê·¸ì¸ ë¯¸ì‚¬ìš© ì‹œ ìˆ˜ë™ ì •ì˜ */
.line-clamp-4 {
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
